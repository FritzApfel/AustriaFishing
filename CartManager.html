class CartManager {
constructor() {
this.items = JSON.parse(localStorage.getItem("cart") || "{}");
this.isLoggedIn = localStorage.getItem("userLoggedIn") !== null;
this.total = 0;
this.discounted = false;

this.ul = document.getElementById("items");
this.totalEl = document.getElementById("total");
this.discountSection = document.getElementById("discount-section");
this.loginWarning = document.getElementById("login-warning");

// Event Listener für Lösch-Buttons
this.ul.addEventListener("click", (e) => {
if (e.target.classList.contains("delete-item")) {
const id = e.target.getAttribute("data-id");
this.deleteItem(id);
}
});

this.renderCart();
}

renderCart() {
this.ul.innerHTML = "";
this.total = 0;

if (Object.keys(this.items).length === 0) {
this.ul.innerHTML = "<li>Ihr Warenkorb ist leer.</li>";
this.discountSection.style.display = "none";
this.loginWarning.style.display = "none";
this.totalEl.textContent = "0 €";
return;
}

for (const id in this.items) {
const item = this.items[id];
const li = document.createElement("li");
li.innerHTML = `
${item.name} x${item.qty}
<span class="price">${(item.price * item.qty).toFixed(2)} €</span>
<button class="delete-item" data-id="${id}">Löschen</button>
`;
this.ul.appendChild(li);
this.total += item.price * item.qty;
}

this.totalEl.textContent = this.total.toFixed(2) + " €";

if (this.isLoggedIn) {
this.discountSection.style.display = "block";
this.loginWarning.style.display = "none";
} else {
this.discountSection.style.display = "none";
this.loginWarning.style.display = "block";
}
}

deleteItem(id) {
if (this.items[id]) {
delete this.items[id];
localStorage.setItem("cart", JSON.stringify(this.items));
this.discounted = false; // Optional: Rabatt zurücksetzen bei Änderung
this.renderCart();
}
}

applyDiscount() {
const codeInput = document.getElementById("code");
const code = codeInput.value.trim().toLowerCase();

if (code === "summer1" && this.total > 0 && !this.discounted) {
this.total *= 0.9;
this.discounted = true;
alert("Rabattcode angewendet! 10% Rabatt.");
} else if (this.discounted) {
alert("Rabatt wurde bereits angewendet.");
} else {
alert("Ungültiger Rabattcode.");
}
this.totalEl.textContent = this.total.toFixed(2) + " €";
}

checkout() {
if (!this.isLoggedIn) {
alert("Bitte melden Sie sich zuerst an.");
window.location.href = "login.html";
return;
}
if (Object.keys(this.items).length === 0) {
alert("Ihr Warenkorb ist leer.");
return;
}
alert("Vielen Dank für Ihren Einkauf!");
localStorage.removeItem("cart");
window.location.href = "index.html";
}
}

// Initialisierung und Zuweisung der globalen Funktionen für Buttons
const cartManager = new CartManager();

window.applyDiscount = () => cartManager.applyDiscount();
window.checkout = () => cartManager.checkout();
